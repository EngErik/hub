#!/bin/bash

# Hack
if [ -z "${JAVA_HOME}" ] ; then
  JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64/jre
  echo "Using Java Home Hack, KILL ME WITH FIRE"
fi

# Exit on any error
#
set -e

if [ -z "${APP_NAME}"] ; then
  APP_NAME="hub"
fi

# Let's check some assumptions!
APP_HOME=${HOME}/${APP_NAME}/
APP_LOGS=${HOME}/${APP_NAME}/log/
APP_STATE=${HOME}/${APP_NAME}/run/

# Should be running as the app-name user
if [ "$(whoami)" != "${APP_NAME}" ] ; then
  echo "Application should be running as '${APP_NAME}', aborting for safety"
  exit 2
fi

if [ ! -d ${APP_HOME} ] ; then
  echo "Application home not present : ${APP_HOME}"
  exit 3
fi

if [ ! -d ${APP_LOGS} ] ; then
  echo "Applicaion log directory not present : ${APP_LOGS} / Creating!"
  mkdir -p ${APP_LOGS}
fi

if [ ! -d ${APP_STATE} ] ; then
  echo "Applicaion state directory not present : ${APP_STATE} / Creating!"
  mkdir -p ${APP_STATE}
fi

pushd ${APP_HOME}

# HACK
find -type d -exec chmod +x {} \;

# Use the parent PID as our "ID"
ID=$$
JAVA_OPTS_FILE=${APP_STATE}/javaopts-${ID}

# Redirect output to a debug file for now
exec >${APP_STATE}/upstart-debug-${ID}

# TODO These should be implemented differently, long-term
cat > ${JAVA_OPTS_FILE} <<JAVA_OPTS
 -d64
 -server
 -Xmx450m
 -Xms256m
 -XX:NewSize=100m
 -XX:+UseG1GC
 -XX:MaxGCPauseMillis=100
 -agentlib:jdwp=transport=dt_socket,address=3333,server=y,suspend=n

 -Dcom.sun.management.jmxremote
 -Dcom.sun.management.jmxremote.port=8888
 -Dcom.sun.management.jmxremote.ssl=false
 -Dcom.sun.management.jmxremote.authenticate=false
 -Dlogback.configurationFile=${APP_HOME}/conf/logback.xml

 -XX:+PrintGCDetails
 -XX:+PrintTenuringDistribution
 -XX:+PrintGCDateStamps

 -Dsun.net.inetaddr.ttl=0

 -Xloggc:${APP_LOGS}/hub_gc.log-${ID}-$(date -u '+%Y-%m-%d-%H-%M-%S')
JAVA_OPTS

JAVA_OPTS="$(cat ${JAVA_OPTS_FILE})"

MAIN_CLASS="com.flightstats.hub.app.HubMain"

CLI="${JAVA_HOME}/bin/java -cp ${APP_HOME}lib/* ${JAVA_OPTS} ${MAIN_CLASS} ${APP_HOME}/conf/hub.properties"

set -f
echo "Running : ${CLI}"
${CLI}
